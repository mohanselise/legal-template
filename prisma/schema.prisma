// Prisma Schema for Legal Templates
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Organization model for enterprise multi-tenancy
model Organization {
  id           String   @id @default(cuid())
  clerkOrgId   String   @unique // Clerk organization ID
  name         String
  slug         String   @unique
  logoUrl      String?

  // Org settings/limits
  maxUsers     Int      @default(10)
  maxTemplates Int      @default(50)

  // SELISE Signature credentials (optional - falls back to system settings)
  seliseClientId     String?
  seliseClientSecret String?

  // Relations
  templates         Template[]
  permissions       OrganizationPermission[]
  letterheads       OrganizationLetterhead[]
  templateRequests  TemplateRequest[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([clerkOrgId])
  @@index([slug])
}

// Organization letterhead for document templates
model OrganizationLetterhead {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // File metadata
  name           String       // Display name
  fileUrl        String       // UploadThing URL
  fileKey        String       // UploadThing file key (for deletion)
  fileName       String       // Original filename
  fileType       String       // MIME type (application/pdf, image/png, etc.)

  // Page dimensions (in pixels)
  pageWidth      Int
  pageHeight     Int

  // Content area boundaries (in pixels)
  contentAreaX      Int
  contentAreaY      Int
  contentAreaWidth  Int
  contentAreaHeight Int

  // Settings
  isDefault      Boolean      @default(false)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, name])
  @@index([organizationId])
}

// User profile for onboarding status and extended profile data
model UserProfile {
  id                       String    @id @default(cuid())
  clerkUserId              String    @unique // Clerk user ID

  // Profile basics
  jobTitle                 String?
  department               String?

  // Onboarding tracking
  onboardingCompleted      Boolean   @default(false)
  onboardingCompletedAt    DateTime?
  onboardingStepsCompleted String[]  @default([]) // ["profile", "org_settings", "invite_team"]

  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  @@index([clerkUserId])
}

// Granular organization permissions (for custom role overrides)
model OrganizationPermission {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Permission name (e.g., "templates.create", "settings.integrations")
  permission     String

  // Roles that have this permission (org_admin, org_editor, org_member)
  roles          String[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, permission])
  @@index([organizationId])
}

// Template model for legal document templates
model Template {
  id               String   @id @default(cuid())
  slug             String   @unique // e.g., "employment-agreement"
  title            String
  description      String
  icon             String   @default("FileText") // lucide icon name
  available        Boolean  @default(false)
  popular          Boolean  @default(false)
  href             String
  keywords         String[] @default([])
  estimatedMinutes Int?
  systemPromptRole String?  // AI role (e.g., "expert legal drafter")
  systemPrompt     String?  @db.Text // AI system prompt for document generation

  // UILM Translation Keys (for multi-language support via SELISE Blocks)
  // Module: templates (ID: 03e5475d-506d-4ad1-8d07-23fa768a7925)
  uilmTitleKey       String? // UILM key for translated title
  uilmDescriptionKey String? // UILM key for translated description

  // Internal Preview Access
  previewToken       String?  @unique // Secret token for draft preview access

  // Organization ownership (null = global/public template)
  organizationId     String?
  organization       Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  screens TemplateScreen[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([available])
  @@index([slug])
  @@index([organizationId])
}

// Screen/Step within a template form
model TemplateScreen {
  id          String     @id @default(cuid())
  templateId  String
  template    Template   @relation(fields: [templateId], references: [id], onDelete: Cascade)

  title       String     // e.g., "Company Information"
  description String?    // Optional helper text
  type        ScreenType @default(standard) // Screen type: standard, signatory, or dynamic
  order       Int        // Display order (0, 1, 2...)
  aiPrompt    String?    @db.Text // AI prompt to run on step completion
  aiOutputSchema String? @db.Text // JSON schema for AI output
  
  // Dynamic screen configuration (for type=dynamic)
  dynamicPrompt     String? @db.Text // AI prompt to generate form fields on-the-fly
  dynamicMaxFields  Int?    @default(5) // Maximum number of fields to generate

  // Signatory screen configuration (for type=signatory)
  signatoryConfig   String? @db.Text // JSON config: {partyTypes, allowMultiple, minSignatories, maxSignatories, requiredParties, collectPhone, collectTitle}

  // UILM Translation Keys (for multi-language support via SELISE Blocks)
  uilmTitleKey       String? // UILM key for translated screen title
  uilmDescriptionKey String? // UILM key for translated screen description

  // Apply Standards feature (auto-fill fields with AI suggestions)
  enableApplyStandards Boolean @default(false) // Show "Apply Standards" button for this screen

  // Conditional visibility - show/hide screen based on previous form responses
  conditions String? @db.Text // JSON: {operator: "and"|"or", rules: [{field, op, value}]}

  fields TemplateField[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@index([templateId, order])
}

// Field within a template screen
model TemplateField {
  id        String         @id @default(cuid())
  screenId  String
  screen    TemplateScreen @relation(fields: [screenId], references: [id], onDelete: Cascade)

  name        String    // Field key (e.g., "companyName")
  label       String    // Display label
  type        FieldType // text, email, date, number, checkbox, select
  required    Boolean   @default(false)
  placeholder String?
  helpText    String?
  options     String[]  @default([]) // For select fields
  order       Int       // Display order within screen

  // AI Smart Suggestions - auto-fill from enrichment context
  aiSuggestionEnabled Boolean @default(false)
  aiSuggestionKey     String? // Key path in enrichmentContext (e.g., "suggestedEmail" or "Company Info.currency")

  // UILM Translation Keys (for multi-language support via SELISE Blocks)
  uilmLabelKey       String? // UILM key for translated field label
  uilmPlaceholderKey String? // UILM key for translated placeholder text
  uilmHelpTextKey    String? // UILM key for translated help text
  uilmOptionsKeys    String[] @default([]) // UILM keys for translated select options (parallel array to options)

  // Conditional visibility - show/hide field based on other form responses
  conditions String? @db.Text // JSON: {operator: "and"|"or", rules: [{field, op, value}]}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([screenId])
  @@index([screenId, order])
}

// Supported field types for form builder
enum FieldType {
  text
  email
  date
  number
  checkbox
  select
  multiselect // Multi-option selection (stores array of values)
  textarea    // Multi-line text input
  phone       // Phone with country code: { countryCode, number }
  address     // Composite: { street, city, state, postalCode, country }
  party       // Name + address composite for Google Places: { name, street, city, state, postalCode, country, placeId? }
  currency    // Amount + currency: { amount, currency }
  percentage  // 0-100 with % display
  url         // URL with validation
}

// Screen types for form builder
enum ScreenType {
  standard  // Regular form screen with fields
  signatory // Special screen for collecting signatory information
  dynamic   // AI-generated screen with fields created on-the-fly
}

// System settings for global configuration
model SystemSettings {
  id                    String   @id @default(cuid())
  key                   String   @unique // Setting key (e.g., "commonPromptInstructions")
  value                 String   @db.Text // Setting value (JSON or text)
  description           String?  // Human-readable description
  updatedBy             String?  // User ID who last updated
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([key])
}

// Analytics: OpenRouter API Usage Logs
model ApiUsageLog {
  id            String   @id @default(cuid())
  
  // Session & Context
  sessionId     String   // Anonymous session UUID
  templateSlug  String?  // e.g., "employment-agreement"
  endpoint      String   // API route path
  
  // OpenRouter Metrics
  model         String   // e.g., "anthropic/claude-3.5-sonnet"
  promptTokens  Int
  completionTokens Int
  totalTokens   Int
  
  // Cost Tracking
  cost          Float    // In USD (actual from API or calculated)
  costMethod    String   // "api" or "calculated"
  
  // Request Metadata
  responseTime  Int     // In milliseconds
  success       Boolean @default(true)
  errorMessage  String? @db.Text
  
  // Timestamps
  createdAt     DateTime @default(now())
  
  @@index([createdAt])
  @@index([templateSlug, createdAt])
  @@index([endpoint, createdAt])
  @@index([sessionId])
}

// Analytics: Cost configuration per model (fallback)
model ModelPricing {
  id                String   @id @default(cuid())
  model             String   @unique
  promptCostPer1k   Float    // Cost per 1k prompt tokens in USD
  completionCostPer1k Float  // Cost per 1k completion tokens in USD
  updatedAt         DateTime @updatedAt
  
  @@index([model])
}

// Template Page - Dynamic content pages stored in database
// These are marketing/landing pages like /en/templates/my-new-template
// separate from the Template model which stores form configuration
model TemplatePage {
  id              String   @id @default(cuid())
  slug            String   // URL slug (e.g., "nda-agreement")
  locale          String   @default("en") // Locale code (e.g., "en", "de", "fr")
  
  // Page Content
  title           String   // Page title (also used for <title>)
  description     String   @db.Text // Meta description
  htmlBody        String   @db.Text @default("") // Legacy HTML content of the page body
  blocks          Json?    // Structured content blocks for rendering
  
  // Open Graph / SEO Metadata
  ogTitle         String?  // Open Graph title (falls back to title if null)
  ogDescription   String?  @db.Text // Open Graph description (falls back to description if null)
  ogImage         String?  // Open Graph image URL
  keywords        String[] @default([]) // SEO keywords
  
  // Publishing
  published       Boolean  @default(false)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Unique constraint: one page per slug+locale combination
  @@unique([slug, locale])
  @@index([slug])
  @@index([locale])
  @@index([published])
}

// Template Request - Requests for SELISE team to create templates on behalf of organizations
model TemplateRequest {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Requester info
  requestedBy     String       // Clerk user ID who made the request
  requesterEmail  String
  requesterName   String

  // Request details
  type            String       @default("collaboration") // "collaboration" | "custom"
  status          String       @default("pending") // "pending" | "in_progress" | "completed" | "cancelled"
  notes           String?      @db.Text

  // Response from SELISE team
  assignedTo      String?      // Admin user handling the request
  responseNotes   String?      @db.Text

  // Resulting template (if created)
  templateId      String?      // Reference to created template

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?

  @@index([organizationId])
  @@index([status])
  @@index([requestedBy])
}
